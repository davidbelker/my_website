---
categories:  
- ""    #the front matter should be like the one found in, e.g., blog2.md. It cannot be like the normal Rmd we used
- ""
date: "2021-10-20"
description: Climate change and temperature anomalies # the title that will show up once someone gets to this page
draft: false
image: climate_change.jpg # save picture in \static\img\blogs. Acceptable formats= jpg, jpeg, or png . Your iPhone pics wont work

keywords: ""
slug: risk_return # slug is the shorthand URL address... no spaces plz
title: Risk-Return of DJIA stocks
---
  



```{r, setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r load-libraries, include=FALSE, echo=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(infer)
library(kableExtra)
library(lubridate)
library(patchwork)
library(rvest)
library(scales)
```



# Climate change and temperature anomalies 




```{r weather_data, cache=TRUE, echo=FALSE}

weather <- 
  read_csv("https://data.giss.nasa.gov/gistemp/tabledata_v4/NH.Ts+dSST.csv", 
           skip = 1, 
           na = "***")

```




```{r tidyweather, echo=FALSE}
tidyweather <- weather %>%
  select(Year:Dec)%>% # selecting year and 12 month variables
  pivot_longer(cols=2:13, # converting dataframe to long format
               names_to ="Month",
               values_to = "delta")

glimpse(tidyweather)

```

## Plotting Temperature deviation

Below you can see plots of the data using a time-series scatter plot, and a trendline. 


```{r scatter_plot, fig.width = 12, echo=FALSE}

tidyweather <- tidyweather %>%
  mutate(date = ymd(paste(as.character(Year), Month, "1")), # add columns date, month and year
         month = month(date, label=TRUE),
         year = year(date))

ggplot(tidyweather, aes(x=date, y = delta))+
  geom_point(size = 0.8)+ # add points
  geom_smooth(color="red") + # add trendline
  theme_bw() +
  theme(panel.border = element_blank()) +
  labs ( # change titles and axis names
    title = "Weather Anomalies",
    subtitle = "Temperature deviations have increased since 1880",
    x = "Year",
    y = "Temperature deviation in degrees Celsius"
  )

```

## Is the effect of increasing temperature more pronounced in some months? 

Overall, it appears that the effect of increasing temperature is more pronounced in February, March, April and October. Potential explanations for the increase in February, March and April may include the significant drop in Northern Hemisphere snow cover and Arctic sea ice during these months.


```{r facet_wrap, fig.width = 12, echo=FALSE}
ggplot(tidyweather, aes(x=date, y = delta))+
  geom_point(size = 0.8)+
  geom_smooth(color="red") +
  facet_wrap(vars(month)) + # show each month individually
  theme_bw() +
  theme(panel.border = element_blank(), # remove background
        strip.background = element_blank() # remove chart title formatting for better readability
        ) +
  labs (
    title = "Weather Anomalies",
    subtitle = "More pronounced increases in fall and spring",
    x = "Year",
    y = "Temperature deviation in degrees Celsius"
  )


```




```{r intervals, echo=FALSE}

comparison <- tidyweather %>% 
  filter(Year>= 1881) %>%     #remove years prior to 1881
  #create new variable 'interval', and assign values based on criteria below:
  mutate(interval = case_when(
    Year %in% c(1881:1920) ~ "1881-1920",
    Year %in% c(1921:1950) ~ "1921-1950",
    Year %in% c(1951:1980) ~ "1951-1980",
    Year %in% c(1981:2010) ~ "1981-2010",
    TRUE ~ "2011-present"
  ))

```

## Highest temperature deviation in the interval from 2010 - today

```{r density_plot, fig.width = 12, echo=FALSE}

ggplot(comparison, aes(x=delta, fill=interval, color = interval), legend.position = "none")+
  geom_density(alpha=0.2) +   #density plot with tranparency set to 20%
  theme_bw() +
  theme(legend.title = element_blank(), panel.border = element_blank()) + # remove legend title
  labs (
    title = "Density Plot for Monthly Temperature Anomalies",
    x = "Temperature deviation in degrees Celsius", 
    y     = "Density"         #changing y-axis label to sentence case
  )

```




```{r averaging, fig.width = 12, echo=FALSE}

#creating yearly averages
average_annual_anomaly <- tidyweather %>% 
  group_by(year) %>%   #grouping data by Year
  
  # creating summaries for mean delta 
  # use `na.rm=TRUE` to eliminate NA (not available) values 
  summarise(
    annual_average_delta = mean(delta, na.rm = TRUE)
  )

#plotting the data:
ggplot(average_annual_anomaly, aes(x = year, y = annual_average_delta))+
  geom_point(size = 1.1)+
  
  #Fit the best fit line, using LOESS method
  geom_smooth(color = "red")+
  
  #change to theme_bw() to have white background + black frame around plot
  theme_bw() +
  theme(panel.border = element_blank()) +
  labs (
    title = "Average Yearly Temperature Anomaly",
    x = "Year",
    y = "Average annual temperature deviation in degrees Celsius"
  )                         


```


## Confidence intervals for temperature anomalies for the period from 2011 - present

Below you can find two computations of the confidence interval for temperature deviations. The latter is computed using a simulation-nased nootstrap distribution.

```{r, calculate_CI_using_formula, echo=FALSE}

formula_ci <- comparison %>% 
 filter(date >= ymd("2011-01-01"), date < ymd("2021-09-01")) %>%
  group_by(interval) %>% # group by interval to calculate statistics for entire period 2011-present
  summarise(  # calculate summary statistics for temperature deviation (delta) using summarise and stat functions
    mean_annual_delta = mean(delta), # calculate mean, SD, count, SE, lower/upper 95% CI (see this line and below)
    sd_annual_delta = sd(delta),
    count = n(),
    se_annual_delta = sd_annual_delta / sqrt(count),
    t_critical = qt(0.975, count -1),
    lower = mean_annual_delta - t_critical * se_annual_delta,
    upper = mean_annual_delta + t_critical * se_annual_delta,
  ) %>% 
  select(interval, mean_annual_delta, sd_annual_delta, se_annual_delta, lower, upper) %>% # select columns for table
  rename(c("Period"="interval", "Mean"="mean_annual_delta", "Standard Deviation"="sd_annual_delta", "Standard Error"="se_annual_delta", "Lower CI Border"="lower", "Upper CI Border"="upper")) %>% # rename columns
  kable(digits = 2) %>% # choose two digits after comma
  kable_styling()
 
formula_ci # print
```


```{r, calculate_CI_using_bootstrap, fig.width = 12, echo=FALSE}
# use the infer package to construct a 95% CI for delta
formula_ci <- comparison %>% 
 filter(year >= "2011", year < "2021") %>% # choose the interval 2011 to 2020, as 2021 has incomplete data
  group_by(interval) %>% # group by interval to calculate statistics for entire period 2011-present
  summarise(  # calculate summary statistics for temperature deviation (delta) using summarise and stat functions
    mean_annual_delta = mean(delta), # calculate mean, SD, count, SE, lower/upper 95% CI (see this line and below)
    sd_annual_delta = sd(delta),
    count = n(),
    se_annual_delta = sd_annual_delta / sqrt(count),
    t_critical = qt(0.975, count -1),
    lower = mean_annual_delta - t_critical * se_annual_delta,
    upper = mean_annual_delta + t_critical * se_annual_delta,
  ) %>% 
  select(lower, upper) 
  
boot_delta <- comparison %>% 
  filter(year >= "2011", year < "2021") %>% # filter for years 2011-present
  group_by(interval) %>% 
  specify(response = delta) %>% # bootstrap step 1: specify variable
  generate(reps = 1000, type = "bootstrap") %>% # bootstrap step 2: specify number of reps to generate
  calculate(stat = "mean") # bootstrap step 3: choose statistic to calculate


percentile_ci <- boot_delta %>% 
  get_confidence_interval(level = 0.95, type = "percentile") # use get_ci to get the 95% confidence interval


visualize(boot_delta) + # visualize 
  shade_confidence_interval(endpoints = percentile_ci, color = "red") +
  labs(
      title = "Simulation-Based Bootstrap Distribution and Confidence Interval of Delta",
      x = "Delta",
      y = "Frequency"
  ) +
  theme_bw() +
  theme(panel.border = element_blank())


```

